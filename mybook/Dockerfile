# ğŸš€ ì•ˆì „í•œ Frontend Dockerfile - ê¸°ì¡´ ê¸°ëŠ¥ ëª¨ë‘ ë³´ì¡´
# Jenkinsì—ì„œ ì´ë¯¸ ë¹Œë“œëœ dist í´ë”ë¥¼ ì§ì ‘ ì‚¬ìš©

FROM nginx:alpine

# ë¹Œë“œ ì •ë³´ (ê¸°ì¡´ê³¼ ë™ì¼)
ARG BUILD_NUMBER
ARG BUILD_TIMESTAMP
ARG CACHEBUST=1

# ë©”íƒ€ë°ì´í„° (ê¸°ì¡´ê³¼ ë™ì¼)
LABEL maintainer="ahyoon_test_final <kimay9623@naver.com>"
LABEL description="SSAFY CICD Frontend - Optimized Vue.js Application with Nginx"
LABEL version="2.0.0"
LABEL build.number="${BUILD_NUMBER}"
LABEL build.timestamp="${BUILD_TIMESTAMP}"

# ì‹œê°„ëŒ€ ì„¤ì • (ê¸°ì¡´ê³¼ ë™ì¼)
ENV TZ=Asia/Seoul
RUN apk add --no-cache tzdata && \
    ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && \
    echo $TZ > /etc/timezone

# í—¬ìŠ¤ì²´í¬ìš© ë„êµ¬ ì„¤ì¹˜ (ê¸°ì¡´ê³¼ ë™ì¼)
RUN apk add --no-cache curl

# ğŸ¯ í•µì‹¬: Jenkinsì—ì„œ ë¹Œë“œí•œ dist í´ë” ì§ì ‘ ë³µì‚¬
COPY dist/ /usr/share/nginx/html/

# nginx ì„¤ì • íŒŒì¼ ë³µì‚¬ (ê¸°ì¡´ ìœ„ì¹˜ì—ì„œ ì§ì ‘)
COPY nginx.conf /etc/nginx/nginx.conf

# í—¬ìŠ¤ì²´í¬ìš© ì—”ë“œí¬ì¸íŠ¸ ìƒì„± (ê¸°ì¡´ í—¬ìŠ¤ì²´í¬ ê²½ë¡œ í˜¸í™˜)
RUN echo '<!DOCTYPE html><html><head><title>Health Check</title></head><body><h1>OK</h1><p>Service is healthy</p></body></html>' > /usr/share/nginx/html/health

# ë¹Œë“œ ì •ë³´ íŒŒì¼ ìƒì„± (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
RUN echo "Build: ${BUILD_NUMBER:-unknown} at ${BUILD_TIMESTAMP:-unknown} (${CACHEBUST:-1})" > /usr/share/nginx/html/build-info.txt

# ê¶Œí•œ ì„¤ì • (ê¸°ì¡´ê³¼ ë™ì¼)
RUN chown -R nginx:nginx /usr/share/nginx/html && \
    chown -R nginx:nginx /var/cache/nginx && \
    chown -R nginx:nginx /var/log/nginx && \
    chown -R nginx:nginx /etc/nginx/conf.d && \
    touch /var/run/nginx.pid && \
    chown -R nginx:nginx /var/run/nginx.pid

# nginx ì‚¬ìš©ìë¡œ ì‹¤í–‰ (ê¸°ì¡´ê³¼ ë™ì¼)
USER nginx

# í¬íŠ¸ ë…¸ì¶œ (ê¸°ì¡´ê³¼ ë™ì¼)
EXPOSE 80

# í—¬ìŠ¤ì²´í¬ (ê¸°ì¡´ê³¼ ë™ì¼í•œ ì„¤ì •)
HEALTHCHECK --interval=30s --timeout=5s --start-period=30s --retries=3 \
    CMD curl -f http://localhost/health || exit 1

# nginx ì‹¤í–‰ (ê¸°ì¡´ê³¼ ë™ì¼)
CMD ["nginx", "-g", "daemon off;"]