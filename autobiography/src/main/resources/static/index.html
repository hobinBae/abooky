<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Whisper STT í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; }
        #messages { border: 1px solid #ccc; padding: 1rem; height: 300px; overflow-y: auto; }
        .user { text-align: right; color: #006; }
        .stt  { text-align: left;  color: #090; }
        .error{ text-align: left; color: #f66; }
        button, input { padding: .5rem; margin: .5rem 0; width: 100%; box-sizing: border-box; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<h2>Whisper STT í…ŒìŠ¤íŠ¸</h2>
<div id="messages"></div>

<!-- â‘  customProperNouns ì…ë ¥ í•„ë“œ ì¶”ê°€ -->
<input type="text" id="properInput" placeholder="ê³ ìœ ëª…ì‚¬ë¥¼ ì‰¼í‘œë¡œ êµ¬ë¶„í•´ ì…ë ¥í•˜ì„¸ìš”" />

<button id="recordBtn">ğŸ™ï¸ ë…¹ìŒ ì‹œì‘</button>
<button id="stopBtn" disabled>â¹ï¸ ë…¹ìŒ ì¤‘ì§€</button>

<script>
    const baseUrl    = 'http://localhost:8080/api/stt/whisper';
    const msgsEl     = document.getElementById('messages');
    const recordBtn  = document.getElementById('recordBtn');
    const stopBtn    = document.getElementById('stopBtn');
    // â‘¡ properInput ìš”ì†Œë¥¼ ì—¬ê¸°ì„œ ê°€ì ¸ì™€ì•¼ í•©ë‹ˆë‹¤
    const properInput = document.getElementById('properInput');

    let mediaRecorder, chunks, stream;

    function appendMessage(txt, cls) {
        const d = document.createElement('div');
        d.className = cls;
        d.textContent = txt;
        msgsEl.appendChild(d);
        msgsEl.scrollTop = msgsEl.scrollHeight;
    }

    recordBtn.onclick = async () => {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            chunks = [];
            mediaRecorder.ondataavailable = e => {
                if (e.data.size > 0) chunks.push(e.data);
            };
            mediaRecorder.start();
            recordBtn.disabled = true;
            stopBtn.disabled = false;
            appendMessage('ğŸ™ï¸ ë…¹ìŒ ì‹œì‘!', 'user');
        } catch (e) {
            appendMessage('âŒ ë…¹ìŒ ì˜¤ë¥˜: ' + e.message, 'error');
        }
    };

    stopBtn.onclick = () => {
        if (!mediaRecorder || mediaRecorder.state !== 'recording') return;
        mediaRecorder.stop();
        stream.getTracks().forEach(t => t.stop());
        recordBtn.disabled = false;
        stopBtn.disabled = true;
        appendMessage('ğŸ”Š Whisperë¡œ ìŒì„± ì „ì†¡ ì¤‘...', 'user');

        mediaRecorder.onstop = async () => {
            const blob = new Blob(chunks, { type: mediaRecorder.mimeType });
            try {
                const form = new FormData();
                form.append('audio', blob, 'audio.webm');

                // â‘¢ customProperNouns ê°’ ì½ì–´ì„œ í¼ì— ì¶”ê°€
                const customProperNouns = properInput.value.trim();
                if (customProperNouns) {
                    form.append('customProperNouns', customProperNouns);
                }

                const res = await axios.post(baseUrl, form, { timeout: 30000 });
                appendMessage(res.data.text, 'stt');
            } catch (e) {
                appendMessage('âŒ Whisper STT ì˜¤ë¥˜: ' +
                    (e.response?.data?.message || e.message), 'error');
            }
        };
    };
</script>
</body>
</html>
