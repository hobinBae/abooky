<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ğŸ”¸ ìì„œì „ ì±•í„° ê¸°ë°˜ ì¸í„°ë·° ì‹œìŠ¤í…œ (VAD ì ìš© + ì—í”¼ì†Œë“œ ì €ì¥)</title>
    <style>
        body { font-family: sans-serif; max-width: 700px; margin: 2rem auto; }
        #messages { border: 1px solid #ccc; padding: 1rem; height: 300px; overflow-y: auto; }
        .ai    { text-align: left;  color: #090; }
        .user  { text-align: right; color: #006; }
        .error { text-align: left; color: #f66; }
        .system { text-align: center; color: #888; font-style: italic; }
        button, input { padding: .5rem; margin: .5rem 0; width: 100%; box-sizing: border-box; }
        #audioLevel { width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        #audioLevelBar { height: 100%; background: linear-gradient(90deg, #4CAF50, #FFC107, #FF5722); width: 0%; transition: width 0.1s ease; }
        .settings { background: #f9f9f9; padding: 1rem; border-radius: 5px; margin: 1rem 0; }
        .settings label { display: block; margin: .5rem 0; }
        #progressInfo { background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0; display: none; }
        #progressBar { background: #4CAF50; height: 100%; width: 0%; transition: width 0.3s; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<h2>ğŸ”¸ ìì„œì „ ì±•í„° ê¸°ë°˜ ì¸í„°ë·° ì‹œìŠ¤í…œ</h2>

<!-- ì§„í–‰ ìƒíƒœ í‘œì‹œ -->
<div id="progressInfo">
    <div id="chapterInfo" style="font-weight:bold; color:#0066cc;"></div>
    <div id="stageInfo" style="color:#666; font-size:0.9em;"></div>
    <div style="background:#fff; border-radius:10px; height:8px; margin:5px 0; overflow:hidden;">
        <div id="progressBar"></div>
    </div>
</div>

<!-- ëŒ€í™” ë¡œê·¸ -->
<div id="messages"></div>

<!-- ì„¤ì • -->
<div class="settings">
    <label><input type="checkbox" id="enableVAD" checked /> VAD ì‚¬ìš©</label>
    <label>ê°ì§€ ì„ê³„ê°’: <span id="thresholdValue">0.01</span>
        <input type="range" id="threshold" min="0.001" max="0.1" step="0.001" value="0.01" />
    </label>
    <label>ë¬´ìŒ í—ˆìš© ì‹œê°„(ì´ˆ): <span id="silenceTimeValue">10</span>
        <input type="range" id="silenceTime" min="1" max="30" step="1" value="10" />
    </label>
</div>

<!-- ì˜¤ë””ì˜¤ ë ˆë²¨ ë°” -->
<div id="audioLevel"><div id="audioLevelBar"></div></div>

<!-- ì‚¬ìš©ì ì…ë ¥ -->
<input type="text" id="properInput" placeholder="ê³ ìœ ëª…ì‚¬ ì…ë ¥ (ì‰¼í‘œ êµ¬ë¶„)" />

<!-- ì£¼ìš” ë²„íŠ¼ -->
<button id="startBtn">â–¶ ì—í”¼ì†Œë“œ ì‹œì‘</button>
<button id="recordBtn" disabled>ğŸ™ï¸ ë…¹ìŒ ì‹œì‘</button>
<button id="stopBtn" disabled>â¹ï¸ ë…¹ìŒ ì¤‘ì§€</button>
<button id="nextQuestionBtn" disabled>â–¶ ë‹¤ìŒ ì§ˆë¬¸ ë°›ê¸°</button>
<button id="saveEpisodeBtn" style="background:#4CAF50; color:white;">ğŸ’¾ ì—í”¼ì†Œë“œ ì €ì¥</button>

<!-- ê°œë°œì ë„êµ¬ -->
<div style="margin:10px 0; padding:10px; background:#f0f8ff; border-radius:5px;">
    <h4>ğŸ”§ ê°œë°œì ë„êµ¬</h4>
    <div>ì„¸ì…˜ ID: <span id="sessionInfo"></span></div>
    <div>ìƒíƒœ: <span id="statusInfo">ëŒ€ê¸° ì¤‘</span></div>
    <button id="clearBtn" style="width:auto; padding:5px 10px; margin-right:5px;">ë©”ì‹œì§€ ì§€ìš°ê¸°</button>
    <button id="initDataBtn" style="width:auto; padding:5px 10px; background:#ff6b6b; color:white; margin-right:5px;">í…œí”Œë¦¿ ìƒˆë¡œê³ ì¹¨</button>
</div>

<script>
    const msgs = document.getElementById('messages');
    const startBtn = document.getElementById('startBtn');
    const recordBtn = document.getElementById('recordBtn');
    const stopBtn = document.getElementById('stopBtn');
    const nextQuestionBtn = document.getElementById('nextQuestionBtn');
    const saveEpisodeBtn = document.getElementById('saveEpisodeBtn');
    const clearBtn = document.getElementById('clearBtn');
    const initDataBtn = document.getElementById('initDataBtn');
    const threshold = document.getElementById('threshold');
    const thresholdValue = document.getElementById('thresholdValue');
    const silenceTime = document.getElementById('silenceTime');
    const silenceTimeValue = document.getElementById('silenceTimeValue');
    const audioLevelBar = document.getElementById('audioLevelBar');
    const sessionInfo = document.getElementById('sessionInfo');
    const statusInfo = document.getElementById('statusInfo');
    const progressInfo = document.getElementById('progressInfo');
    const chapterInfo = document.getElementById('chapterInfo');
    const stageInfo = document.getElementById('stageInfo');
    const progressBar = document.getElementById('progressBar');

    let sessionId = crypto.randomUUID();
    const bookId = 1;  // ì‹¤ì œë¡  ì‚¬ìš©ì ì„ íƒê°’ ë˜ëŠ” URL íŒŒë¼ë¯¸í„° ì‚¬ìš©
    let chunkIndex = 0;
    let source, mediaRecorder, stream, chunkTimer, audioContext, analyser;
    let isRecording = false, voiceDetected = false, lastSpeechTime = 0, currentAudioLevel = 0;

    sessionInfo.textContent = sessionId;
    threshold.oninput = () => thresholdValue.textContent = threshold.value;
    silenceTime.oninput = () => silenceTimeValue.textContent = silenceTime.value;

    function append(txt, cls='ai') {
        const d = document.createElement('div');
        d.className = cls;
        d.textContent = txt;
        msgs.appendChild(d);
        msgs.scrollTop = msgs.scrollHeight;
    }

    clearBtn.onclick = () => {
        msgs.innerHTML = '';
        statusInfo.textContent = 'ë©”ì‹œì§€ ì§€ì›Œì§';
    };
    initDataBtn.onclick = async () => {
        initDataBtn.disabled = true;
        statusInfo.textContent = 'í…œí”Œë¦¿ ì—…ë°ì´íŠ¸ ì¤‘â€¦';
        try {
            await axios.post('http://localhost:8080/api/chapter/init');
            append('âœ… í…œí”Œë¦¿ ì—…ë°ì´íŠ¸ ì™„ë£Œ!', 'system');
            statusInfo.textContent = 'ì—…ë°ì´íŠ¸ ì™„ë£Œ';
        } catch (e) {
            append('âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: '+e.message,'error');
        } finally { initDataBtn.disabled = false; }
    };

    startBtn.onclick = () => {
        source = new EventSource(`http://localhost:8080/api/conversation/stream?sessionId=${sessionId}&useChapterMode=true`);
        source.addEventListener('question', e => {
            const data = JSON.parse(e.data);
            append(`AI: ${data.text}`, 'ai');
            if (data.currentChapter) {
                progressInfo.style.display = 'block';
                chapterInfo.textContent = `ğŸ“– ${data.currentChapter}`;
                stageInfo.textContent = `ğŸ“ ${data.currentStage}`;
                progressBar.style.width = (data.overallProgress||0)+'%';
                if (data.isLastQuestion) append('ğŸ‰ ì¸í„°ë·° ì™„ë£Œ!','system');
            }
            recordBtn.disabled = false;
            nextQuestionBtn.disabled = false;
            statusInfo.textContent = 'ì§ˆë¬¸ ìˆ˜ì‹ ë¨';
        });
        source.addEventListener('partialTranscript', e => {
            const { chunkIndex, text } = JSON.parse(e.data);
            append(`(${chunkIndex}) ìŒì„± ì¸ì‹â€¦${text}`, 'user');
        });
        source.addEventListener('finalTranscript', e => {
            const { chunkIndex, text } = JSON.parse(e.data);
            append(`âœ… ìµœì¢… ì¸ì‹ (#${chunkIndex}): ${text}`, 'user');
            nextQuestionBtn.disabled = false;
            statusInfo.textContent = 'ë‹µë³€ ì™„ë£Œ';
        });
        source.addEventListener('error', () => { append('âŒ SSE ì—ëŸ¬','error'); source.close(); });
        append(`ì„¸ì…˜ ì—´ë¦¼: ${sessionId}`, 'system');
        startBtn.disabled = true;
    };

    recordBtn.onclick = async () => {
        stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        audioContext = new (window.AudioContext||window.webkitAudioContext)();
        const mic = audioContext.createMediaStreamSource(stream);
        analyser = audioContext.createAnalyser(); mic.connect(analyser);
        isRecording = true; voiceDetected = false; lastSpeechTime = Date.now();
        startChunkRecorder(); analyzeAudio();
        append('ğŸ™ï¸ ë…¹ìŒ ì‹œì‘','system');
        recordBtn.disabled = true; stopBtn.disabled = false;
    };
    stopBtn.onclick = () => {
        isRecording = false; voiceDetected = false; clearTimeout(chunkTimer);
        if (mediaRecorder?.state==='recording') mediaRecorder.stop();
        stream.getTracks().forEach(t=>t.stop());
        audioContext.close(); audioContext = analyser = null;
        audioLevelBar.style.width = '0%';
        append('ğŸ”Š ë…¹ìŒ ì¤‘ì§€','user');
        stopBtn.disabled = true; recordBtn.disabled = false;
    };

    function analyzeAudio() {
        if (!analyser) return;
        const buf = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(buf);
        const rms = Math.sqrt(buf.reduce((a,v)=>a+v*v,0)/buf.length);
        currentAudioLevel = rms/255;
        audioLevelBar.style.width = (currentAudioLevel*100)+'%';
        const th = parseFloat(threshold.value), st = parseFloat(silenceTime.value)*1000;
        if (currentAudioLevel>th) { lastSpeechTime=Date.now(); if(!voiceDetected){ voiceDetected=true; append('ğŸ¤ ìŒì„± ê°ì§€','system'); } }
        else if (voiceDetected && Date.now()-lastSpeechTime>st) { voiceDetected=false; append('ğŸ”‡ ìŒì„± ì¤‘ë‹¨','system'); }
        if (isRecording) requestAnimationFrame(analyzeAudio);
    }

    function startChunkRecorder() {
        mediaRecorder = new MediaRecorder(stream,{ mimeType:'audio/webm;codecs=opus' });
        mediaRecorder.ondataavailable = async e => {
            if (!e.data||e.data.size<1000) { chunkIndex++; append(`ğŸ§¹ ë¬´ìŒ ì²­í¬ ë¬´ì‹œ (size=${e.data.size})`,'system'); return; }
            const form = new FormData();
            form.append('sessionId', sessionId);
            form.append('chunkIndex', chunkIndex++);
            form.append('audio', e.data, 'audio.webm');
            form.append('answer','true');
            form.append('audioLevel', currentAudioLevel.toFixed(3));
            if (document.getElementById('properInput').value.trim())
                form.append('customProperNouns', document.getElementById('properInput').value.trim());
            append(`ğŸ“¤ ì²­í¬ #${chunkIndex-1} ì „ì†¡â€¦`,'system');
            try { await axios.post('http://localhost:8080/api/stt/chunk', form, { timeout:60000 }); }
            catch(err){ append('âŒ STT ì˜¤ë¥˜: '+err.message,'error'); }
        };
        mediaRecorder.onstop = () => { if (isRecording) startChunkRecorder(); };
        mediaRecorder.start();
        chunkTimer = setTimeout(()=>{ if(mediaRecorder.state==='recording') mediaRecorder.stop(); }, 60000);
    }

    nextQuestionBtn.onclick = async () => {
        nextQuestionBtn.disabled = true;
        statusInfo.textContent = 'ë‹¤ìŒ ì§ˆë¬¸ ìš”ì²­â€¦';
        try {
            await axios.post('http://localhost:8080/api/conversation/next', null, { params:{ sessionId } });
            statusInfo.textContent = 'ìš”ì²­ ì™„ë£Œ';
        } catch(e){ append('âŒ ìš”ì²­ ì‹¤íŒ¨: '+e.message,'error'); nextQuestionBtn.disabled=false; }
    };

    saveEpisodeBtn.onclick = async () => {
        saveEpisodeBtn.disabled = true;
        append('ğŸ’¾ ì—í”¼ì†Œë“œ ìƒì„± ìš”ì²­â€¦','system');
        try {
            const res = await axios.post(
                `http://localhost:8080/api/v1/books/1/episodes`,
                null,
                { params:{ sessionId } }
            );
            const ep = res.data.data;
            append(`âœ… ì—í”¼ì†Œë“œ ìƒì„± ì„±ê³µ! ID: ${ep.episodeId}`, 'system');
        } catch(e) {
            append('âŒ ì—í”¼ì†Œë“œ ìƒì„± ì‹¤íŒ¨: '+(e.response?.data?.message||e.message),'error');
        } finally { saveEpisodeBtn.disabled = false; }
    };
</script>
</body>
</html>