<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Autobiography STT + SSE í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; }
        #messages { border: 1px solid #ccc; padding: 1rem; height: 300px; overflow-y: auto; }
        .ai    { text-align: left;  color: #090; }
        .user  { text-align: right; color: #006; }
        .error { text-align: left; color: #f66; }
        button, input { padding: .5rem; margin: .5rem 0; width: 100%; box-sizing: border-box; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<h2>Autobiography STT + SSE í…ŒìŠ¤íŠ¸</h2>
<div id="messages"></div>

<input type="text" id="properInput" placeholder="ê³ ìœ ëª…ì‚¬ë¥¼ ì‰¼í‘œë¡œ êµ¬ë¶„í•´ ì…ë ¥í•˜ì„¸ìš”" />
<button id="startBtn">â–¶ ì—í”¼ì†Œë“œ ì‹œì‘</button>
<button id="recordBtn" disabled>ğŸ™ï¸ ë…¹ìŒ ì‹œì‘</button>
<button id="stopBtn" disabled>â¹ï¸ ë…¹ìŒ ì¤‘ì§€</button>

<script>
    const msgs = document.getElementById('messages');
    const properInput = document.getElementById('properInput');
    const startBtn   = document.getElementById('startBtn');
    const recordBtn  = document.getElementById('recordBtn');
    const stopBtn    = document.getElementById('stopBtn');

    let sessionId = crypto.randomUUID();
    let episodeId = 1;     // í…ŒìŠ¤íŠ¸ìš© ì—í”¼ì†Œë“œ ID
    let chunkIndex = 0;
    let source, mediaRecorder, chunks, stream;

    function append(txt, cls='ai') {
        const d = document.createElement('div');
        d.className = cls;
        d.textContent = txt;
        msgs.appendChild(d);
        msgs.scrollTop = msgs.scrollHeight;
    }

    startBtn.onclick = () => {
        // 1) SSE ì—°ê²°
        source = new EventSource(
            `http://localhost:8080/api/stream/questions?sessionId=${sessionId}&episodeId=${episodeId}`
        );
        source.addEventListener('question', e => {
            const { text } = JSON.parse(e.data);
            append(`AI: ${text}`, 'ai');
            recordBtn.disabled = false;
        });
        source.addEventListener('error', e => {
            append('âŒ SSE ì—ëŸ¬', 'error');
            source.close();
        });
        append(`ì„¸ì…˜ ì—´ë¦¼: ${sessionId}`, 'user');
        startBtn.disabled = true;
    };

    recordBtn.onclick = async () => {
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        chunks = [];
        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.start();
        append('ğŸ™ï¸ ë…¹ìŒ ì‹œì‘', 'user');
        recordBtn.disabled = true;
        stopBtn.disabled = false;
    };

    stopBtn.onclick = () => {
        mediaRecorder.stop();
        stream.getTracks().forEach(t => t.stop());
        append('ğŸ”Š STT ì „ì†¡ ì¤‘...', 'user');
        stopBtn.disabled = true;
    };

    // ë…¹ìŒì´ ë©ˆì¶”ë©´ ì²­í¬ ì „ì†¡
    navigator.mediaDevices.getUserMedia;  // ensure API loaded
    document.addEventListener('visibilitychange', () => {}); // avoid unused

    // onstop í•¸ë“¤ëŸ¬
    let onstop = mediaRecorder => {
        mediaRecorder.onstop = async () => {
            const blob = new Blob(chunks, { type: mediaRecorder.mimeType });
            const form = new FormData();
            form.append('sessionId', sessionId);
            form.append('chunkIndex', chunkIndex++);
            form.append('audio', blob, 'audio.webm');
            form.append('finalTranscript', 'true'); // í´ë¼ì´ì–¸íŠ¸ì—ì„œ finalì´ë¼ê³  ì•Œë ¤ì¤„ ë•Œ

            const cpns = properInput.value.trim();
            if (cpns) form.append('customProperNouns', cpns);

            try {
                await axios.post('http://localhost:8080/api/stt/chunk', form, { timeout: 60000 });
            } catch (e) {
                append('âŒ STT Chunk ì˜¤ë¥˜: ' + (e.response?.data?.message || e.message), 'error');
            }
            recordBtn.disabled = false;
        };
    };

    // startBtn ì´í›„ recorder ë‹¤ì‹œ ì„¤ì •
    recordBtn.addEventListener('click', () => onstop(mediaRecorder));
    stopBtn.addEventListener('click', () => onstop(mediaRecorder));
</script>
</body>
</html>
