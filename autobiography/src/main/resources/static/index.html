<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ğŸ”¸ ìì„œì „ ì±•í„° ê¸°ë°˜ ì¸í„°ë·° ì‹œìŠ¤í…œ (VAD ì ìš© + ì—í”¼ì†Œë“œ ì €ì¥)</title>
    <style>
        body { font-family: sans-serif; max-width: 700px; margin: 2rem auto; }
        #messages { border: 1px solid #ccc; padding: 1rem; height: 300px; overflow-y: auto; }
        .ai    { text-align: left;  color: #090; }
        .user  { text-align: right; color: #006; }
        .error { text-align: left; color: #f66; }
        .system { text-align: center; color: #888; font-style: italic; }
        button, input { padding: .5rem; margin: .5rem 0; width: 100%; box-sizing: border-box; }
        #audioLevel { width: 100%; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        #audioLevelBar { height: 100%; background: linear-gradient(90deg, #4CAF50, #FFC107, #FF5722); width: 0%; transition: width 0.1s ease; }
        .settings { background: #f9f9f9; padding: 1rem; border-radius: 5px; margin: 1rem 0; }
        .settings label { display: block; margin: .5rem 0; }
        #progressInfo { background: #e7f3ff; padding: 10px; border-radius: 5px; margin: 10px 0; display: none; }
        #progressBarWrap { background:#fff; border-radius:10px; height:8px; margin:5px 0; overflow:hidden; }
        #progressBar { background: #4CAF50; height: 100%; width: 0%; transition: width 0.3s; }
        .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#eef7ee; color:#2a6f2a; margin-left:6px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<h2>ğŸ”¸ ìì„œì „ ì±•í„° ê¸°ë°˜ ì¸í„°ë·° ì‹œìŠ¤í…œ</h2>

<!-- ì§„í–‰ ìƒíƒœ í‘œì‹œ -->
<div id="progressInfo">
    <div id="chapterInfo" style="font-weight:bold; color:#0066cc;"></div>
    <div id="stageInfo" style="color:#666; font-size:0.9em;"></div>
    <div id="progressBarWrap"><div id="progressBar"></div></div>
</div>

<!-- ëŒ€í™” ë¡œê·¸ -->
<div id="messages"></div>

<!-- ì„¤ì • -->
<div class="settings">
    <label><input type="checkbox" id="enableVAD" checked /> VAD ì‚¬ìš©</label>
    <label>ê°ì§€ ì„ê³„ê°’: <span id="thresholdValue">0.01</span>
        <input type="range" id="threshold" min="0.001" max="0.1" step="0.001" value="0.01" />
    </label>
    <label>ë¬´ìŒ í—ˆìš© ì‹œê°„(ì´ˆ): <span id="silenceTimeValue">10</span>
        <input type="range" id="silenceTime" min="1" max="30" step="1" value="10" />
    </label>
</div>

<!-- ì˜¤ë””ì˜¤ ë ˆë²¨ ë°” -->
<div id="audioLevel"><div id="audioLevelBar"></div></div>

<!-- ì‚¬ìš©ì ì…ë ¥ -->
<input type="text" id="properInput" placeholder="ê³ ìœ ëª…ì‚¬ ì…ë ¥ (ì‰¼í‘œ êµ¬ë¶„)" />

<!-- ì£¼ìš” ë²„íŠ¼ -->
<button id="startBtn">â–¶ ì—í”¼ì†Œë“œ ì‹œì‘</button>
<button id="recordBtn" disabled>ğŸ™ï¸ ë…¹ìŒ ì‹œì‘</button>
<button id="stopBtn" disabled>â¹ï¸ ë…¹ìŒ ì¤‘ì§€</button>
<button id="nextQuestionBtn" disabled>â–¶ ë‹¤ìŒ ì§ˆë¬¸ ë°›ê¸°</button>
<button id="saveEpisodeBtn" style="background:#4CAF50; color:white;">ğŸ’¾ ì§€ê¸ˆê¹Œì§€ ì—í”¼ì†Œë“œë¡œ ì €ì¥</button>

<!-- ê°œë°œì ë„êµ¬ -->
<div style="margin:10px 0; padding:10px; background:#f0f8ff; border-radius:5px;">
    <h4>ğŸ”§ ê°œë°œì ë„êµ¬</h4>
    <div>ì„¸ì…˜ ID: <span id="sessionInfo"></span></div>
    <div>ìƒíƒœ: <span id="statusInfo">ëŒ€ê¸° ì¤‘</span></div>
    <button id="clearBtn" style="width:auto; padding:5px 10px; margin-right:5px;">ë©”ì‹œì§€ ì§€ìš°ê¸°</button>
    <button id="initDataBtn" style="width:auto; padding:5px 10px; background:#ff6b6b; color:white; margin-right:5px;">í…œí”Œë¦¿ ìƒˆë¡œê³ ì¹¨</button>
</div>

<script>
    const msgs = document.getElementById('messages');
    const startBtn = document.getElementById('startBtn');
    const recordBtn = document.getElementById('recordBtn');
    const stopBtn = document.getElementById('stopBtn');
    const nextQuestionBtn = document.getElementById('nextQuestionBtn');
    const saveEpisodeBtn = document.getElementById('saveEpisodeBtn');
    const clearBtn = document.getElementById('clearBtn');
    const initDataBtn = document.getElementById('initDataBtn');
    const threshold = document.getElementById('threshold');
    const thresholdValue = document.getElementById('thresholdValue');
    const silenceTime = document.getElementById('silenceTime');
    const silenceTimeValue = document.getElementById('silenceTimeValue');
    const audioLevelBar = document.getElementById('audioLevelBar');
    const sessionInfo = document.getElementById('sessionInfo');
    const statusInfo = document.getElementById('statusInfo');
    const progressInfo = document.getElementById('progressInfo');
    const chapterInfo = document.getElementById('chapterInfo');
    const stageInfo = document.getElementById('stageInfo');
    const progressBar = document.getElementById('progressBar');

    let sessionId = null;
    const bookId = 1;  // ì‹¤ì œë¡  ì‚¬ìš©ì ì„ íƒê°’ ë˜ëŠ” URL íŒŒë¼ë¯¸í„° ì‚¬ìš©
    let chunkIndex = 0;
    let source, mediaRecorder, stream, chunkTimer, audioContext, analyser;
    let isRecording = false, voiceDetected = false, lastSpeechTime = 0, currentAudioLevel = 0;

    sessionInfo.textContent = sessionId;
    threshold.oninput = () => thresholdValue.textContent = threshold.value;
    silenceTime.oninput = () => silenceTimeValue.textContent = silenceTime.value;

    function append(txt, cls='ai') {
        const d = document.createElement('div');
        d.className = cls;
        d.textContent = txt;
        msgs.appendChild(d);
        msgs.scrollTop = msgs.scrollHeight;
    }

    function banner(text) {
        append(text, 'system');
    }

    function setProgress(payload = {}) {
        if (!payload.currentChapter && !payload.currentStage) return;
        progressInfo.style.display = 'block';
        if (payload.currentChapter) chapterInfo.innerHTML = `ğŸ“– ${payload.currentChapter}`;
        if (payload.currentStage) stageInfo.innerHTML = `ğŸ“ ${payload.currentStage}`;
        if (typeof payload.overallProgress === 'number') {
            progressBar.style.width = (payload.overallProgress || 0) + '%';
        }
    }

    clearBtn.onclick = () => {
        msgs.innerHTML = '';
        statusInfo.textContent = 'ë©”ì‹œì§€ ì§€ì›Œì§';
    };

    initDataBtn.onclick = async () => {
        initDataBtn.disabled = true;
        statusInfo.textContent = 'í…œí”Œë¦¿ ì—…ë°ì´íŠ¸ ì¤‘â€¦';
        try {
            await axios.post('http://localhost:8080/api/chapter/init');
            banner('âœ… í…œí”Œë¦¿ ì—…ë°ì´íŠ¸ ì™„ë£Œ!');
            statusInfo.textContent = 'ì—…ë°ì´íŠ¸ ì™„ë£Œ';
        } catch (e) {
            append('âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: '+e.message,'error');
        } finally { initDataBtn.disabled = false; }
    };

    // === SSE ì—°ê²° ===
    startBtn.onclick = async () => {
        startBtn.disabled = true;
        statusInfo.textContent = 'ìƒˆë¡œìš´ ëŒ€í™” ì„¸ì…˜ ìƒì„± ì¤‘...';

        try {
            // 1ë‹¨ê³„: POST /api/conversation APIë¥¼ í˜¸ì¶œí•˜ì—¬ ì„¸ì…˜ì„ "ìƒì„±"í•©ë‹ˆë‹¤.
            const response = await axios.post('http://localhost:8080/api/v1/conversation');

            // ì„œë²„ë¡œë¶€í„° ë°›ì€ sessionIdë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥í•©ë‹ˆë‹¤.
            sessionId = response.data.data.sessionId;
            sessionInfo.textContent = sessionId;
            banner(`âœ… ì„¸ì…˜ ìƒì„± ì„±ê³µ: ${sessionId}`);
            statusInfo.textContent = 'ì„¸ì…˜ ìƒì„± ì™„ë£Œ. SSE ì—°ê²° ì¤‘...';

            // 2ë‹¨ê³„: ë°œê¸‰ë°›ì€ sessionIdë¡œ SSE ìŠ¤íŠ¸ë¦¼ì— "ì—°ê²°"í•©ë‹ˆë‹¤.
            source = new EventSource(`http://localhost:8080/api/v1/conversation/${sessionId}/stream`);

            // ì´ì œ ëª¨ë“  ì§ˆë¬¸(ì²« ì§ˆë¬¸ í¬í•¨)ì€ ì´ SSE ë¦¬ìŠ¤ë„ˆë¥¼ í†µí•´ ì¼ê´€ë˜ê²Œ ìˆ˜ì‹ ë©ë‹ˆë‹¤.
            source.addEventListener('question', e => {
                const data = JSON.parse(e.data);
                append(`AI: ${data.text}`, 'ai');
                setProgress(data);
                if (data.isLastQuestion) {
                    banner('ğŸ‰ ëª¨ë“  ì¸í„°ë·°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    recordBtn.disabled = true;
                    stopBtn.disabled = true;
                    nextQuestionBtn.disabled = true;
                } else {
                    recordBtn.disabled = false;
                    nextQuestionBtn.disabled = true; // ë‹µë³€ì„ í•´ì•¼ ë‹¤ìŒ ì§ˆë¬¸ ë²„íŠ¼ì´ í™œì„±í™”ë˜ë„ë¡
                }
                statusInfo.textContent = 'ì§ˆë¬¸ ìˆ˜ì‹ ë¨';
            });

            source.addEventListener('partialTranscript', e => {
                const { chunkIndex, text } = JSON.parse(e.data);
                append(`(${chunkIndex}) ìŒì„± ì¸ì‹â€¦ ${text}`, 'user');
            });

            // ì¬ì—°ê²° ì‹œ ë§ˆì§€ë§‰ ì§ˆë¬¸ì„ ë°›ì€ í›„ ë…¹ìŒ ë° ë‹¤ìŒ ì§ˆë¬¸ ë²„íŠ¼ ìƒíƒœë¥¼ ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // (ì´ ë¶€ë¶„ì€ UXì— ë”°ë¼ ì»¤ìŠ¤í„°ë§ˆì´ì§• ê°€ëŠ¥)

            source.addEventListener('error', () => {
                append('âŒ SSE ì—°ê²° ì˜¤ë¥˜. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.','error');
                if (source) source.close();
            });

        } catch (error) {
            append('âŒ ì„¸ì…˜ ì‹œì‘ ì‹¤íŒ¨: ' + (error.response?.data?.message || error.message), 'error');
            startBtn.disabled = false;
            statusInfo.textContent = 'ì‹œì‘ ì‹¤íŒ¨';
        }
    };
    // í˜ì´ì§€ ì´íƒˆ ì‹œ SSE ì •ë¦¬
    window.addEventListener('beforeunload', () => { try { source && source.close(); } catch(_){} });

    // === ë…¹ìŒ ì»¨íŠ¸ë¡¤ ===
    recordBtn.onclick = async () => {
        stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        audioContext = new (window.AudioContext||window.webkitAudioContext)();
        const mic = audioContext.createMediaStreamSource(stream);
        analyser = audioContext.createAnalyser(); mic.connect(analyser);
        isRecording = true; voiceDetected = false; lastSpeechTime = Date.now();
        startChunkRecorder(); analyzeAudio();
        banner('ğŸ™ï¸ ë…¹ìŒ ì‹œì‘');
        recordBtn.disabled = true; stopBtn.disabled = false;
        nextQuestionBtn.disabled = true;
    };

    stopBtn.onclick = () => {
        isRecording = false; voiceDetected = false; clearTimeout(chunkTimer);
        if (mediaRecorder?.state==='recording') mediaRecorder.stop();
        stream.getTracks().forEach(t=>t.stop());
        audioContext.close(); audioContext = analyser = null;
        audioLevelBar.style.width = '0%';
        append('ğŸ”Š ë…¹ìŒ ì¤‘ì§€','user');
        stopBtn.disabled = true; recordBtn.disabled = false;
        nextQuestionBtn.disabled = false;
    };

    function analyzeAudio() {
        if (!analyser) return;
        const buf = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(buf);
        const rms = Math.sqrt(buf.reduce((a,v)=>a+v*v,0)/buf.length);
        currentAudioLevel = rms/255;
        audioLevelBar.style.width = (currentAudioLevel*100)+'%';
        const th = parseFloat(threshold.value), st = parseFloat(silenceTime.value)*1000;
        if (currentAudioLevel>th) { lastSpeechTime=Date.now(); if(!voiceDetected){ voiceDetected=true; banner('ğŸ¤ ìŒì„± ê°ì§€'); } }
        else if (voiceDetected && Date.now()-lastSpeechTime>st) { voiceDetected=false; banner('ğŸ”‡ ìŒì„± ì¤‘ë‹¨'); }
        if (isRecording) requestAnimationFrame(analyzeAudio);
    }

    function startChunkRecorder() {
        mediaRecorder = new MediaRecorder(stream,{ mimeType:'audio/webm;codecs=opus' });
        mediaRecorder.ondataavailable = async e => {
            if (!e.data||e.data.size<1000) { chunkIndex++; banner(`ğŸ§¹ ë¬´ìŒ ì²­í¬ ë¬´ì‹œ (size=${e.data.size})`); return; }
            const form = new FormData();
            form.append('sessionId', sessionId);
            form.append('chunkIndex', chunkIndex++);
            form.append('audio', e.data, 'audio.webm');
            form.append('answer','true');
            form.append('audioLevel', currentAudioLevel.toFixed(3));
            const proper = document.getElementById('properInput').value.trim();
            if (proper) form.append('customProperNouns', proper);
            banner(`ğŸ“¤ ì²­í¬ #${chunkIndex-1} ì „ì†¡â€¦`);
            try { await axios.post('http://localhost:8080/api/stt/chunk', form, { timeout:60000 }); }
            catch(err){ append('âŒ STT ì˜¤ë¥˜: '+(err.response?.data?.message||err.message),'error'); }
        };
        mediaRecorder.onstop = () => { if (isRecording) startChunkRecorder(); };
        mediaRecorder.start();
        chunkTimer = setTimeout(()=>{ if(mediaRecorder.state==='recording') mediaRecorder.stop(); }, 60000);
    }

    // === ë‹¤ìŒ ì§ˆë¬¸ ë²„íŠ¼ ë¡œì§ (ë³€ê²½ ì—†ìŒ) ===
    // ì´ ë¡œì§ì€ ì´ë¯¸ ìƒˆë¡œìš´ API êµ¬ì¡°ì™€ ì™„ë²½í•˜ê²Œ í˜¸í™˜ë©ë‹ˆë‹¤.
    nextQuestionBtn.onclick = async () => {
        nextQuestionBtn.disabled = true;
        recordBtn.disabled = true; // ë‹¤ìŒ ì§ˆë¬¸ì„ ê¸°ë‹¤ë¦¬ëŠ” ë™ì•ˆ ë…¹ìŒ ë¹„í™œì„±í™”
        statusInfo.textContent = 'ë‹¤ìŒ ì§ˆë¬¸ ìš”ì²­â€¦';
        try {
            // â˜… ë³€ê²½ì  3: URL íŒŒë¼ë¯¸í„° ë°©ì‹ì„ POST ë³¸ë¬¸ìœ¼ë¡œ ë³´ë‚´ëŠ” ë°©ì‹ìœ¼ë¡œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì„œë²„ ì»¨íŠ¸ë¡¤ëŸ¬ ìˆ˜ì • í•„ìš”)
            // í˜„ì¬ëŠ” @RequestParamì„ ì‚¬ìš©í•˜ë¯€ë¡œ ê·¸ëŒ€ë¡œ ë‘¡ë‹ˆë‹¤.
            await axios.post(`http://localhost:8080/api/v1/conversation/next?sessionId=${sessionId}`);
            statusInfo.textContent = 'ìš”ì²­ ì™„ë£Œ. ì‘ë‹µ ëŒ€ê¸° ì¤‘...';
        } catch(e){
            append('âŒ ìš”ì²­ ì‹¤íŒ¨: ' + (e.response?.data?.message || e.message),'error');
            nextQuestionBtn.disabled = false; // ì‹¤íŒ¨ ì‹œ ë‹¤ì‹œ í™œì„±í™”
            recordBtn.disabled = false;
        }
    };

    // ìˆ˜ë™ ì €ì¥ (í˜„ì¬ êµ¬ê°„ì„ ì—í”¼ì†Œë“œë¡œ ì €ì¥)
    saveEpisodeBtn.onclick = async () => {
        saveEpisodeBtn.disabled = true;
        banner('ğŸ’¾ ì—í”¼ì†Œë“œ ìƒì„± ìš”ì²­â€¦');
        try {
            // ì„œë²„ì—ì„œ createEpisodeFromCurrentWindowë¡œ ë¼ìš°íŒ…ë˜ì–´ ìˆë‹¤ë©´ ë™ì¼ ì—”ë“œí¬ì¸íŠ¸ë¡œ ë™ì‘
            const res = await axios.post(
                `http://localhost:8080/api/v1/books/${bookId}/episodes`,
                null,
                { params:{ sessionId } }
            );
            const ep = res.data.data;
            banner(`âœ… ì—í”¼ì†Œë“œ ìƒì„± ì„±ê³µ! ID: ${ep.episodeId}`);
        } catch(e) {
            append('âŒ ì—í”¼ì†Œë“œ ìƒì„± ì‹¤íŒ¨: '+(e.response?.data?.message||e.message),'error');
        } finally { saveEpisodeBtn.disabled = false; }
    };
</script>
</body>
</html>
