<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Group RTC â€“ Join</title>
    <!-- LiveKit JS SDK (UMD) -->
    <script src="https://cdn.jsdelivr.net/npm/livekit-client@2.15.4/dist/livekit-client.umd.min.js"></script>
    <style>
        body { font-family: system-ui, sans-serif; margin: 16px; }
        .row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 8px; }
        label { font-size: 12px; color: #666; display: block; }
        input, button { padding: 8px; }
        #video-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
        #video-container video { width: 240px; background:#000; }
        #chat { margin-top: 12px; max-width: 640px; }
        #messages { height: 160px; overflow-y: auto; border: 1px solid #ddd; padding: 8px; background: #fafafa; }
        #messages div { margin-bottom: 4px; }
    </style>
</head>
<body>
<h2>ê·¸ë£¹ í™”ìƒ ì±„íŒ… ë°ëª¨</h2>

<div class="row">
    <div>
        <label>ë°±ì—”ë“œ Base URL</label>
        <input id="baseUrl" value="http://localhost:8080" style="width:300px" />
    </div>
    <div>
        <label>Group ID</label>
        <input id="groupId" value="5" style="width:80px" />
    </div>
    <div>
        <label>ë‚´ ì´ë¦„(userName)</label>
        <input id="userName" value="user2" style="width:140px" />
    </div>
</div>

<div class="row">
    <div style="flex:1">
        <label>ë°±ì—”ë“œ JWT (Authorization í—¤ë”ìš©)</label>
        <input id="backendJwt" placeholder="eyJhbGciOi..." style="width:480px" />
    </div>
</div>

<div class="row">
    <button id="createRoomBtn">ë°© ìƒì„±(ì„œë²„)</button>
    <button id="joinBtn">ì…ì¥(í† í° ë°œê¸‰ â†’ ì—°ê²°)</button>
    <button id="leaveBtn" disabled>í‡´ì¥</button>
</div>

<div class="row">
    <button id="toggleCamBtn" disabled>ì¹´ë©”ë¼ On/Off</button>
    <button id="toggleMicBtn" disabled>ë§ˆì´í¬ On/Off</button>
    <button id="shareBtn" disabled>í™”ë©´ê³µìœ </button>
</div>

<div id="video-container"></div>

<div id="chat">
    <h3>ì±„íŒ…</h3>
    <div id="messages"></div>
    <div class="row">
        <input id="chatInput" placeholder="ë©”ì‹œì§€ ì…ë ¥" style="flex:1; min-width:360px" />
        <button id="sendBtn" disabled>ì „ì†¡</button>
    </div>
</div>

<script>
    // LiveKit SDK
    const {
        Room, RoomEvent, createLocalScreenTracks
    } = window.LivekitClient;

    let room = null;
    let camEnabled = false;
    let micEnabled = false;

    function qs(id) { return document.getElementById(id); }
    function logMsg(s) {
        const div = document.createElement('div');
        div.textContent = s;
        qs('messages').appendChild(div);
        qs('messages').scrollTop = qs('messages').scrollHeight;
    }

    // ì°¸ê°€ì íŠ¸ë™ í‘œì‹œ/í•´ì œ
    function hookRoomMediaEvents(r) {
        r.on(RoomEvent.TrackSubscribed, (track, _pub, participant) => {
            const el = track.attach();
            el.dataset.participantSid = participant.sid;
            el.dataset.trackSid = track.sid;
            qs('video-container').appendChild(el);
        });

        r.on(RoomEvent.TrackUnsubscribed, (track) => {
            track.detach().forEach(el => el.remove());
        });

        // ë°ì´í„°(ì±„íŒ…) ìˆ˜ì‹ 
        r.on(RoomEvent.DataReceived, (payload, participant, kind, topic) => {
            try {
                const txt = new TextDecoder().decode(payload);
                const name = participant?.name || participant?.identity || 'unknown';
                logMsg(`${name}: ${txt}`);
            } catch {
                logMsg(`[data:${topic||kind}] ${payload?.byteLength||0} bytes`);
            }
        });

        r.on(RoomEvent.ParticipantConnected, (p) => logMsg(`ğŸ”µ ${p.name||p.identity} ì…ì¥`));
        r.on(RoomEvent.ParticipantDisconnected, (p) => logMsg(`âš« ${p.name||p.identity} í‡´ì¥`));
        r.on(RoomEvent.Disconnected, () => logMsg('â›” ì—°ê²° ì¢…ë£Œ'));
    }

    async function createRoomOnServer() {
        const baseUrl = qs('baseUrl').value.trim();
        const groupId = qs('groupId').value.trim();
        const jwt = qs('backendJwt').value.trim();
        const url = `${baseUrl}/api/v1/groups/${groupId}/rtc/room`;

        const resp = await fetch(url, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${jwt}`
            }
        });
        if (!resp.ok) {
            const text = await resp.text();
            throw new Error(`ë°© ìƒì„± ì‹¤íŒ¨: ${resp.status} ${text}`);
        }
        alert('ë°© ìƒì„± ì„±ê³µ');
    }

    async function requestJoinToken() {
        const baseUrl = qs('baseUrl').value.trim();
        const groupId = qs('groupId').value.trim();
        const userName = qs('userName').value.trim();
        const jwt = qs('backendJwt').value.trim();

        const url = `${baseUrl}/api/v1/groups/${groupId}/rtc/token`;
        const resp = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${jwt}`
            },
            body: JSON.stringify({ userName })
        });

        if (!resp.ok) {
            const text = await resp.text();
            throw new Error(`í† í° ë°œê¸‰ ì‹¤íŒ¨: ${resp.status} ${text}`);
        }
        // ApiResponse ë˜í•‘: { status, message, data: { url, token } ... } í˜•íƒœë¥¼ ê°€ì •
        const json = await resp.json();
        const data = json?.data ?? json; // í˜¹ì‹œ ë˜í•‘ì´ ì—†ë‹¤ë©´ ëŒ€ë¹„
        if (!data?.url || !data?.token) {
            throw new Error('ì‘ë‹µì— url/token ì—†ìŒ');
        }
        return data;
    }

    async function joinRoom() {
        if (room) {
            alert('ì´ë¯¸ ì ‘ì† ì¤‘ì…ë‹ˆë‹¤.');
            return;
        }

        // 1) ì„œë²„ì—ì„œ url/token ë°›ê¸°
        const { url, token } = await requestJoinToken();

        // 2) LiveKit ì ‘ì†
        const r = new Room();
        hookRoomMediaEvents(r);
        await r.connect(url, token);

        // 3) ì¹´ë©”ë¼/ë§ˆì´í¬ ê¸°ë³¸ í™œì„±í™”
        await r.localParticipant.enableCameraAndMicrophone();
        camEnabled = true; micEnabled = true;

        room = r;
        qs('leaveBtn').disabled = false;
        qs('toggleCamBtn').disabled = false;
        qs('toggleMicBtn').disabled = false;
        qs('shareBtn').disabled = false;
        qs('sendBtn').disabled = false;

        logMsg('âœ… ë°© ì ‘ì† ì™„ë£Œ');
    }

    async function leaveRoom() {
        if (!room) return;
        room.disconnect();
        qs('video-container').innerHTML = '';
        room = null;

        qs('leaveBtn').disabled = true;
        qs('toggleCamBtn').disabled = true;
        qs('toggleMicBtn').disabled = true;
        qs('shareBtn').disabled = true;
        qs('sendBtn').disabled = true;

        camEnabled = false; micEnabled = false;
    }

    // UI í•¸ë“¤ëŸ¬
    qs('createRoomBtn').onclick = async () => {
        try {
            await createRoomOnServer();
        } catch (e) {
            console.error(e);
            alert(e.message);
        }
    };

    qs('joinBtn').onclick = async () => {
        try { await joinRoom(); }
        catch (e) {
            console.error(e);
            alert(e.message);
        }
    };

    qs('leaveBtn').onclick = () => leaveRoom();

    qs('toggleCamBtn').onclick = async () => {
        if (!room) return;
        camEnabled = !camEnabled;
        await room.localParticipant.setCameraEnabled(camEnabled);
        qs('toggleCamBtn').textContent = camEnabled ? 'ì¹´ë©”ë¼ Off' : 'ì¹´ë©”ë¼ On';
    };

    qs('toggleMicBtn').onclick = async () => {
        if (!room) return;
        micEnabled = !micEnabled;
        await room.localParticipant.setMicrophoneEnabled(micEnabled);
        qs('toggleMicBtn').textContent = micEnabled ? 'ë§ˆì´í¬ Off' : 'ë§ˆì´í¬ On';
    };

    qs('shareBtn').onclick = async () => {
        if (!room) return;
        try {
            const tracks = await createLocalScreenTracks({ video: true, audio: false });
            await room.localParticipant.publishTracks(tracks);
            // ì‚¬ìš©ìê°€ ë¸Œë¼ìš°ì €ì—ì„œ ê³µìœ  ì¤‘ë‹¨í•˜ë©´ íŠ¸ë™ ì´ë²¤íŠ¸ë¥¼ í†µí•´ ì œê±°ë¨
        } catch (e) {
            console.error('í™”ë©´ê³µìœ  ì‹¤íŒ¨', e);
            alert('í™”ë©´ê³µìœ  ì‹¤íŒ¨: ' + e.message);
        }
    };

    // ì±„íŒ…: DataChannel ì‚¬ìš©
    qs('sendBtn').onclick = async () => {
        if (!room) return;
        const txt = qs('chatInput').value.trim();
        if (!txt) return;
        const payload = new TextEncoder().encode(txt);
        await room.localParticipant.publishData(payload, { reliable: true, topic: 'chat' });
        logMsg(`ë‚˜: ${txt}`);
        qs('chatInput').value = '';
    };
</script>
</body>
</html>
